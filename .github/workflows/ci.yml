name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run unit tests
        run: go test -v -race -coverprofile=coverage.out ./...

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Build binary with GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: build --snapshot --clean --single-target

      - name: Find built binary
        id: find-binary
        run: |
          BINARY=$(find dist -name 'conjurctl' -type f | head -1)
          echo "binary=$BINARY" >> $GITHUB_OUTPUT
          echo "Found binary: $BINARY"
          chmod +x "$BINARY"

      - name: Run integration tests
        run: |
          INTEGRATION_TEST=1 \
          CONJUR_BINARY="${{ steps.find-binary.outputs.binary }}" \
          go test -v -timeout 120s ./test/integration/...

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: v2.0.2

  changelog:
    name: Changelog
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Build changelog tool
        run: go build -o changelog ./cmd/changelog

      - name: Validate changelog
        run: ./changelog validate

      - name: Run changelog tests
        run: go test -v ./cmd/changelog/...

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint, changelog]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Build binary
        run: |
          CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s" -o conjurctl ./cmd/conjurctl
          ./conjurctl --help
