name: CI

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
    branches: [main, master]

env:
  REGISTRY: ghcr.io
  # Use separate packages: main repo for releases, -dev suffix for development builds
  IMAGE_NAME: ${{ github.repository }}
  IMAGE_NAME_DEV: ${{ github.repository }}-dev

permissions:
  contents: write
  packages: write

jobs:
  # ============================================
  # Validation jobs - run in parallel
  # ============================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
      - run: go test -v -race -coverprofile=coverage.out ./...

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
      - uses: golangci/golangci-lint-action@v7
        with:
          version: v2.0.2

  changelog:
    name: Changelog
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
      - run: go build -o changelog ./cmd/changelog
      - run: ./changelog validate
      - run: go test -v ./cmd/changelog/...

  # ============================================
  # Build - single GoReleaser build for everything
  # ============================================
  build:
    name: Build Binaries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
      - name: Build with GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          # Build all targets for releases, single target for PRs/branches
          args: build --snapshot --clean ${{ github.event_name == 'pull_request' && '--single-target' || '' }}
      - uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: dist/
          retention-days: 7

  # ============================================
  # Integration tests - uses build artifacts
  # ============================================
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
      - run: go mod download
      - uses: actions/download-artifact@v4
        with:
          name: binaries
          path: dist/
      - name: Find binary
        id: find-binary
        run: |
          BINARY=$(find dist -path '*linux_amd64*' -name 'conjurctl' -type f | head -1)
          chmod +x "$BINARY"
          echo "binary=$(pwd)/$BINARY" >> $GITHUB_OUTPUT
      - name: Run integration tests
        run: |
          INTEGRATION_TEST=1 \
          CONJUR_BINARY="${{ steps.find-binary.outputs.binary }}" \
          go test -v -timeout 120s ./test/integration/...

  # ============================================
  # Docker build - uses pre-built binary
  # ============================================
  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: binaries
          path: dist/
      - name: Prepare binaries for Docker
        run: |
          # Prepare amd64 binary
          BINARY_AMD64=$(find dist -path '*linux_amd64*' -name 'conjurctl' -type f | head -1)
          if [ -z "$BINARY_AMD64" ]; then
            echo "ERROR: Could not find linux amd64 binary"
            find dist -type f -name 'conjurctl' -ls
            exit 1
          fi
          chmod +x "$BINARY_AMD64"
          mkdir -p bin/linux/amd64
          cp "$BINARY_AMD64" bin/linux/amd64/conjurctl
          
          # Prepare arm64 binary
          BINARY_ARM64=$(find dist -path '*linux_arm64*' -name 'conjurctl' -type f | head -1)
          if [ -z "$BINARY_ARM64" ]; then
            echo "ERROR: Could not find linux arm64 binary"
            find dist -type f -name 'conjurctl' -ls
            exit 1
          fi
          chmod +x "$BINARY_ARM64"
          mkdir -p bin/linux/arm64
          cp "$BINARY_ARM64" bin/linux/arm64/conjurctl
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract metadata (dev builds)
        id: meta-dev
        if: github.event_name != 'pull_request' && !startsWith(github.ref, 'refs/tags/v')
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_DEV }}
          tags: |
            type=raw,value=latest
            type=sha
      - name: Extract metadata (releases)
        id: meta-release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
      - name: Build and push (dev)
        if: github.event_name != 'pull_request' && !startsWith(github.ref, 'refs/tags/v')
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.prebuilt
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta-dev.outputs.tags }}
          labels: ${{ steps.meta-dev.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Build and push (release)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.prebuilt
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta-release.outputs.tags }}
          labels: ${{ steps.meta-release.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Test image
        run: |
          # Test amd64 image (native on CI runner)
          docker build -t conjur-in-go:test -f Dockerfile.prebuilt --build-arg TARGETARCH=amd64 .
          docker run --rm conjur-in-go:test --help
          docker run --rm conjur-in-go:test data-key generate

  # ============================================
  # Release - only on tags, after all validation
  # ============================================
  release:
    name: Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [test, lint, changelog, integration-test, docker]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Prepare changelog
        run: |
          go build -o changelog ./cmd/changelog
          ./changelog extract --version "${GITHUB_REF_NAME}" > RELEASE_NOTES.md
          if [ ! -s RELEASE_NOTES.md ]; then
            echo "Error: No changelog entry found for ${GITHUB_REF_NAME}"
            exit 1
          fi
          cat RELEASE_NOTES.md
      - name: Run GoReleaser Release
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean --release-notes=RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
